<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion | Outils Kodra</title>
  <meta name="description" content="Connectez-vous pour acc&eacute;der &agrave; vos outils Kodra." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #FAFAFA;
      --bg-card: #FFFFFF;
      --border: #E4E4E7;
      --border-subtle: #F0F0F2;
      --orange: #F97316;
      --orange-hover: #EA580C;
      --orange-light: rgba(249,115,22,0.07);
      --orange-border: rgba(249,115,22,0.2);
      --orange-glow: rgba(249,115,22,0.12);
      --green: #16A34A;
      --green-light: rgba(22,163,74,0.08);
      --red: #DC2626;
      --red-light: rgba(220,38,38,0.08);
      --text: #18181B;
      --text2: #52525B;
      --muted: #A1A1AA;
      --radius-md: 8px;
      --radius-lg: 12px;
      --ease: cubic-bezier(0.16, 1, 0.3, 1);
      --duration: 150ms;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg); color: var(--text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px; line-height: 1.6;
      min-height: 100vh; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      -webkit-font-smoothing: antialiased;
      padding: 24px;
    }

    .login-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 40px 36px 36px;
      width: 100%; max-width: 420px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.03);
    }

    .login-logo {
      display: flex; align-items: center; justify-content: center;
      gap: 12px; margin-bottom: 8px;
    }
    .login-logo img { height: 22px; opacity: 0.85; }
    .login-logo .divider { width: 1px; height: 16px; background: var(--border); }
    .login-logo .badge {
      font-size: 11px; font-weight: 600; color: var(--muted);
      letter-spacing: 0.04em; text-transform: uppercase;
    }

    .login-title {
      text-align: center; font-size: 1.35rem; font-weight: 700;
      margin-bottom: 4px; letter-spacing: -0.02em;
    }
    .login-subtitle {
      text-align: center; font-size: 13.5px; color: var(--text2);
      margin-bottom: 28px;
    }

    /* Tabs */
    .tabs {
      display: flex; gap: 0; margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
    }
    .tab {
      flex: 1; padding: 10px 0; text-align: center;
      font-size: 13.5px; font-weight: 550; color: var(--muted);
      cursor: pointer; border: none; background: none;
      border-bottom: 2px solid transparent;
      transition: all var(--duration);
      font-family: 'Inter', sans-serif;
    }
    .tab:hover { color: var(--text2); }
    .tab.active {
      color: var(--orange); border-bottom-color: var(--orange);
    }

    /* Forms */
    .form-group { margin-bottom: 16px; }
    .form-group label {
      display: block; font-size: 13px; font-weight: 550;
      color: var(--text); margin-bottom: 6px;
    }
    .form-group input {
      width: 100%; height: 40px; padding: 0 12px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: var(--radius-md); color: var(--text);
      font-family: 'Inter', sans-serif; font-size: 14px;
      outline: none; transition: border-color var(--duration), box-shadow var(--duration);
    }
    .form-group input:hover { border-color: #C4C4C8; }
    .form-group input:focus {
      border-color: var(--orange);
      box-shadow: 0 0 0 3px var(--orange-glow);
    }
    .form-group input::placeholder { color: var(--muted); }

    .btn-submit {
      width: 100%; height: 40px; border: none;
      border-radius: var(--radius-md);
      background: linear-gradient(180deg, var(--orange) 0%, var(--orange-hover) 100%);
      color: #fff; font-family: 'Inter', sans-serif;
      font-size: 14px; font-weight: 600; cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.15);
      transition: all var(--duration);
    }
    .btn-submit:hover {
      box-shadow: 0 3px 8px rgba(249,115,22,0.25), inset 0 1px 0 rgba(255,255,255,0.12);
      transform: translateY(-0.5px);
    }
    .btn-submit:active { transform: translateY(0); }
    .btn-submit:disabled {
      opacity: 0.5; cursor: not-allowed; transform: none !important;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .separator {
      display: flex; align-items: center; gap: 12px;
      margin: 20px 0; color: var(--muted); font-size: 12px;
    }
    .separator::before, .separator::after {
      content: ''; flex: 1; height: 1px; background: var(--border);
    }

    .btn-magic {
      width: 100%; height: 40px; border: 1px solid var(--border);
      border-radius: var(--radius-md); background: var(--bg-card);
      color: var(--text2); font-family: 'Inter', sans-serif;
      font-size: 13.5px; font-weight: 500; cursor: pointer;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      transition: all var(--duration);
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .btn-magic:hover {
      border-color: #D4D4D8; background: var(--bg); color: var(--text);
    }
    .btn-magic:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Messages */
    .msg {
      padding: 10px 14px; border-radius: var(--radius-md);
      font-size: 13px; margin-bottom: 16px; display: none;
      line-height: 1.5;
    }
    .msg.error {
      display: block; background: var(--red-light);
      color: var(--red); border: 1px solid rgba(220,38,38,0.15);
    }
    .msg.success {
      display: block; background: var(--green-light);
      color: var(--green); border: 1px solid rgba(22,163,74,0.15);
    }

    .footer-text {
      text-align: center; margin-top: 24px;
      font-size: 12px; color: var(--muted);
    }
    .footer-text a { color: var(--text2); text-decoration: none; }
    .footer-text a:hover { color: var(--orange); }

    /* Hidden panels */
    .panel { display: none; }
    .panel.active { display: block; }

    /* Magic link form */
    .magic-form { display: none; }
    .magic-form.active { display: block; }
    .magic-back {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 12.5px; color: var(--muted); cursor: pointer;
      border: none; background: none; font-family: 'Inter', sans-serif;
      margin-bottom: 16px; padding: 4px 0;
      transition: color var(--duration);
    }
    .magic-back:hover { color: var(--text2); }

    /* Loading spinner */
    .spinner {
      display: inline-block; width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: #fff; border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<div class="login-card">
  <div class="login-logo">
    <img src="https://kodra.ca/logo-dark.png" alt="Kodra" />
    <div class="divider"></div>
    <span class="badge">outils</span>
  </div>
  <h1 class="login-title">Outils Kodra</h1>
  <p class="login-subtitle">Connectez-vous pour acc&eacute;der &agrave; vos outils</p>

  <div id="msg" class="msg"></div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="login">Se connecter</button>
    <button class="tab" data-tab="signup">Cr&eacute;er un compte</button>
  </div>

  <!-- LOGIN Panel -->
  <div id="panel-login" class="panel active">
    <div id="login-form-main">
      <form id="form-login">
        <div class="form-group">
          <label for="login-email">Courriel</label>
          <input type="email" id="login-email" placeholder="vous@exemple.com" required autocomplete="email" />
        </div>
        <div class="form-group">
          <label for="login-password">Mot de passe</label>
          <input type="password" id="login-password" placeholder="Votre mot de passe" required autocomplete="current-password" />
        </div>
        <button type="submit" class="btn-submit" id="btn-login">Se connecter</button>
      </form>

      <div class="separator">ou</div>

      <button class="btn-magic" id="btn-show-magic-login">
        <span>&#9993;</span> Se connecter par courriel magique
      </button>
    </div>

    <div id="magic-login" class="magic-form">
      <button class="magic-back" id="btn-back-login">&#8592; Retour</button>
      <form id="form-magic-login">
        <div class="form-group">
          <label for="magic-login-email">Courriel</label>
          <input type="email" id="magic-login-email" placeholder="vous@exemple.com" required autocomplete="email" />
        </div>
        <button type="submit" class="btn-submit" id="btn-magic-login">Envoyer le lien magique</button>
      </form>
    </div>
  </div>

  <!-- SIGNUP Panel -->
  <div id="panel-signup" class="panel">
    <div id="signup-form-main">
      <form id="form-signup">
        <div class="form-group">
          <label for="signup-name">Nom complet</label>
          <input type="text" id="signup-name" placeholder="Jean Tremblay" autocomplete="name" />
        </div>
        <div class="form-group">
          <label for="signup-email">Courriel</label>
          <input type="email" id="signup-email" placeholder="vous@exemple.com" required autocomplete="email" />
        </div>
        <div class="form-group">
          <label for="signup-password">Mot de passe</label>
          <input type="password" id="signup-password" placeholder="Minimum 6 caract&egrave;res" required minlength="6" autocomplete="new-password" />
        </div>
        <button type="submit" class="btn-submit" id="btn-signup">Cr&eacute;er mon compte</button>
      </form>

      <div class="separator">ou</div>

      <button class="btn-magic" id="btn-show-magic-signup">
        <span>&#9993;</span> S'inscrire par courriel magique
      </button>
    </div>

    <div id="magic-signup" class="magic-form">
      <button class="magic-back" id="btn-back-signup">&#8592; Retour</button>
      <form id="form-magic-signup">
        <div class="form-group">
          <label for="magic-signup-email">Courriel</label>
          <input type="email" id="magic-signup-email" placeholder="vous@exemple.com" required autocomplete="email" />
        </div>
        <button type="submit" class="btn-submit" id="btn-magic-signup">Envoyer le lien magique</button>
      </form>
    </div>
  </div>
</div>

<p class="footer-text">
  &copy; 2026 <a href="https://kodra.ca">Kodra Conseil</a>, SENC
</p>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/supabase-config.js"></script>
<script>
// ============================================================
// Login / Signup â€” Outils Kodra
// ============================================================

const msgEl = document.getElementById('msg');

// --- Check if already logged in ---
(async () => {
  const user = await getUser();
  if (user) {
    window.location.href = '/dashboard.html';
  }
})();

// --- Tabs ---
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
    hideMsg();
    // Reset magic link views
    document.querySelectorAll('.magic-form').forEach(f => f.classList.remove('active'));
    document.getElementById('login-form-main').style.display = '';
    document.getElementById('signup-form-main').style.display = '';
  });
});

// --- Magic link toggles ---
document.getElementById('btn-show-magic-login').addEventListener('click', () => {
  document.getElementById('login-form-main').style.display = 'none';
  document.getElementById('magic-login').classList.add('active');
  hideMsg();
});
document.getElementById('btn-back-login').addEventListener('click', () => {
  document.getElementById('login-form-main').style.display = '';
  document.getElementById('magic-login').classList.remove('active');
  hideMsg();
});
document.getElementById('btn-show-magic-signup').addEventListener('click', () => {
  document.getElementById('signup-form-main').style.display = 'none';
  document.getElementById('magic-signup').classList.add('active');
  hideMsg();
});
document.getElementById('btn-back-signup').addEventListener('click', () => {
  document.getElementById('signup-form-main').style.display = '';
  document.getElementById('magic-signup').classList.remove('active');
  hideMsg();
});

// --- Login form ---
document.getElementById('form-login').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('btn-login');
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  hideMsg();
  setLoading(btn, true);

  const { data, error } = await signInWithPassword(email, password);

  if (error) {
    showMsg(translateError(error.message), 'error');
    setLoading(btn, false);
    return;
  }

  window.location.href = '/dashboard.html';
});

// --- Signup form ---
document.getElementById('form-signup').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('btn-signup');
  const name = document.getElementById('signup-name').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value;
  hideMsg();
  setLoading(btn, true);

  const { data, error } = await signUpWithPassword(email, password, name);

  if (error) {
    showMsg(translateError(error.message), 'error');
    setLoading(btn, false);
    return;
  }

  // Check if email confirmation is required
  if (data.user && !data.session) {
    showMsg('Un courriel de confirmation a \u00e9t\u00e9 envoy\u00e9. V\u00e9rifiez votre bo\u00eete de r\u00e9ception.', 'success');
    setLoading(btn, false);
  } else {
    window.location.href = '/dashboard.html';
  }
});

// --- Magic link forms ---
document.getElementById('form-magic-login').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('btn-magic-login');
  const email = document.getElementById('magic-login-email').value.trim();
  hideMsg();
  setLoading(btn, true);

  const { data, error } = await signInWithMagicLink(email);

  if (error) {
    showMsg(translateError(error.message), 'error');
    setLoading(btn, false);
    return;
  }

  showMsg('Lien magique envoy\u00e9\u00a0! V\u00e9rifiez votre bo\u00eete de r\u00e9ception.', 'success');
  setLoading(btn, false);
});

document.getElementById('form-magic-signup').addEventListener('submit', async (e) => {
  e.preventDefault();
  const btn = document.getElementById('btn-magic-signup');
  const email = document.getElementById('magic-signup-email').value.trim();
  hideMsg();
  setLoading(btn, true);

  const { data, error } = await signInWithMagicLink(email);

  if (error) {
    showMsg(translateError(error.message), 'error');
    setLoading(btn, false);
    return;
  }

  showMsg('Lien magique envoy\u00e9\u00a0! V\u00e9rifiez votre bo\u00eete de r\u00e9ception.', 'success');
  setLoading(btn, false);
});

// --- Helpers ---
function showMsg(text, type) {
  msgEl.textContent = text;
  msgEl.className = 'msg ' + type;
}
function hideMsg() {
  msgEl.className = 'msg';
  msgEl.textContent = '';
}

function setLoading(btn, loading) {
  if (loading) {
    btn.disabled = true;
    btn.dataset.originalText = btn.textContent;
    btn.innerHTML = '<span class="spinner"></span>';
  } else {
    btn.disabled = false;
    btn.textContent = btn.dataset.originalText || btn.textContent;
  }
}

function translateError(msg) {
  const map = {
    'Invalid login credentials': 'Identifiants invalides. V\u00e9rifiez votre courriel et mot de passe.',
    'User already registered': 'Un compte existe d\u00e9j\u00e0 avec ce courriel.',
    'Signup requires a valid password': 'Le mot de passe doit contenir au moins 6 caract\u00e8res.',
    'Email not confirmed': 'Veuillez confirmer votre courriel avant de vous connecter.',
    'Email rate limit exceeded': 'Trop de tentatives. R\u00e9essayez dans quelques minutes.',
    'For security purposes, you can only request this after': 'Veuillez patienter quelques secondes avant de r\u00e9essayer.'
  };
  for (const [en, fr] of Object.entries(map)) {
    if (msg.includes(en)) return fr;
  }
  return msg;
}
</script>

</body>
</html>
